<template>
  <div class="asset-owner-selector">
    <a-form :model="formState" layout="horizontal" :rules="rules">
      <!-- 资产选择 -->
      <a-form-item label="资产" v-bind="formItemLayout" name="asset">
        <a-select
          v-model:value="formState.assetId"
          placeholder="请选择资产"
          :options="assetOptions"
          @change="handleAssetChange"
          style="width: 200px;"
        />
      </a-form-item>

      <!-- 属主选择（资产选后必填，编辑时不重置） -->
      <a-form-item label="属主" v-bind="formItemLayout" name="owner">
        <a-select
          v-model:value="formState.ownerId"
          placeholder="请选择属主"
          :options="ownerOptions"
          :disabled="!formState.assetId && !isEditing"
          style="width: 200px;"
        />
      </a-form-item>

      <!-- 操作按钮 -->
      <a-form-item>
        <a-button type="primary" @click="addItem" :disabled="!canAdd">
          {{ isEditing ? '更新' : '添加' }}
        </a-button>
        <a-button @click="resetSelection" style="margin-left: 8px;" v-if="isEditing">
          取消
        </a-button>
        <a-button @click="resetSelection" style="margin-left: 8px;" v-else>
          重置
        </a-button>
      </a-form-item>
    </a-form>

    <!-- 标签列表（替换Table） -->
    <div class="tags-container">
      <a-tag
        v-for="item in selectedItems"
        :key="item.key"
        :closable="true"
        :close-icon="minusIcon"
        @close="deleteItem(item)"
        @click="editItem(item)"
        color="blue"
        style="margin: 4px; cursor: pointer;"
      >
        {{ item.assetName }} - {{ item.ownerName }}
      </a-tag>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed } from 'vue';
import { message } from 'ant-design-vue';
import { MinusOutlined } from '@ant-design/icons-vue'; // 导入减号图标

// 模拟数据（不变）
const assetOptions = ref([
  { label: '资产A', value: 'asset1' },
  { label: '资产B', value: 'asset2' },
  { label: '资产C', value: 'asset3' },
]);
const ownerOptions = ref([
  { label: '属主X', value: 'owner1' },
  { label: '属主Y', value: 'owner2' },
  { label: '属主Z', value: 'owner3' },
]);

// 表单状态（不变）
const formState = reactive({
  assetId: null,
  ownerId: null,
});

// 选中项列表（不变）
const selectedItems = ref([]);

// 编辑状态（简化isEditing为ref）
const isEditing = ref(false);
const editingKey = ref(null);

// 减号图标组件
const minusIcon = () => <MinusOutlined />;

// 验证规则、布局（不变）
const rules = {
  asset: [{ required: true, message: '请选择资产' }],
  owner: [{ required: true, message: '请选择属主' }],
};
const formItemLayout = {
  labelCol: { span: 6 },
  wrapperCol: { span: 18 },
};

// 计算属性：是否可添加/更新（不变）
const canAdd = computed(() => !!formState.assetId && !!formState.ownerId);

// 监听资产变化（不变）
const handleAssetChange = (value) => {
  if (!isEditing.value && !value) {
    formState.ownerId = null;
  }
};

// 编辑项（点击标签进入）
const editItem = (record) => {
  formState.assetId = record.assetId;
  formState.ownerId = record.ownerId;
  isEditing.value = true;
  editingKey.value = record.key;
  message.info('进入编辑模式，请修改后点击更新');
};

// 添加/更新项（不变）
const addItem = () => {
  if (!formState.assetId || !formState.ownerId) {
    message.error('请完整选择资产和属主');
    return;
  }

  const assetLabel = assetOptions.value.find(opt => opt.value === formState.assetId)?.label || '';
  const ownerLabel = ownerOptions.value.find(opt => opt.value === formState.ownerId)?.label || '';
  const newItem = {
    key: editingKey.value || Date.now(),
    assetId: formState.assetId,
    assetName: assetLabel,
    ownerId: formState.ownerId,
    ownerName: ownerLabel,
  };

  if (isEditing.value) {
    const index = selectedItems.value.findIndex(item => item.key === editingKey.value);
    if (index !== -1) {
      selectedItems.value[index] = newItem;
      message.success('更新成功');
    }
  } else {
    const exists = selectedItems.value.some(item => item.assetId === formState.assetId);
    if (exists) {
      message.warning('该资产已添加');
      return;
    }
    selectedItems.value.push(newItem);
    message.success('添加成功');
  }
  resetSelection();
};

// 删除项（点击减号）
const deleteItem = (record) => {
  selectedItems.value = selectedItems.value.filter(item => item.key !== record.key);
  // 如果删除的是编辑项，退出编辑
  if (isEditing.value && record.key === editingKey.value) {
    resetSelection();
  }
  message.success('删除成功');
};

// 重置选择（不变）
const resetSelection = () => {
  formState.assetId = null;
  formState.ownerId = null;
  isEditing.value = false;
  editingKey.value = null;
};
</script>

<style scoped>
.asset-owner-selector {
  padding: 20px;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 16px;
  padding: 8px;
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  min-height: 40px;
}
</style>