<template>
  <a-modal 
    v-model:open="visible" 
    title="新增组件及中间件信息"
    :width="800"
    :mask-closable="false"
    :destroy-on-close="true"
    @ok="handleOk"
    @cancel="handleCancel"
  >
    <template #footer>
      <a-space>
        <a-button @click="handleCancel">取消</a-button>
        <a-button type="primary" @click="handleOk" :loading="loading">保存</a-button>
      </a-space>
    </template>
    
    <a-form 
      ref="formRef"
      :model="formState" 
      :rules="rules"
      :colon="false"
      layout="horizontal"
    >
      <!-- 第一行：组件名称 + 组件版本 -->
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item 
            label="组件名称" 
            name="componentName"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <a-input 
              v-model:value="formState.componentName" 
              placeholder="" 
            />
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item 
            label="组件版本" 
            name="componentVersion"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <a-input 
              v-model:value="formState.componentVersion" 
              placeholder="" 
            />
          </a-form-item>
        </a-col>
      </a-row>
      
      <!-- 第二行：应用资产名称（独占一行） -->
      <a-row>
        <a-col :span="24">
          <a-form-item 
            label="应用资产名称" 
            name="appAssetName"
            :label-col="{ span: 4 }"
            :wrapper-col="{ span: 20 }"
          >
            <a-select 
              v-model:value="formState.appAssetName" 
              placeholder=""
              allow-clear
            >
              <a-select-option 
                v-for="item in appAssetOptions" 
                :key="item.value" 
                :value="item.value"
              >
                {{ item.label }}
              </a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
      </a-row>
      
      <!-- 第三行：主机名 + IP -->
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item 
            label="主机名" 
            name="hostname"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <a-input 
              v-model:value="formState.hostname" 
              placeholder="" 
            />
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item 
            label="IP" 
            name="ip"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <a-input 
              v-model:value="formState.ip" 
              placeholder="" 
            />
          </a-form-item>
        </a-col>
      </a-row>
      
      <!-- 第四行：组件来源 + 组件类型 -->
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item 
            label="组件来源" 
            name="componentSource"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <a-select 
              v-model:value="formState.componentSource" 
              placeholder=""
              allow-clear
            >
              <a-select-option 
                v-for="item in componentSourceOptions" 
                :key="item.value" 
                :value="item.value"
              >
                {{ item.label }}
              </a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item 
            label="组件类型" 
            name="componentType"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <a-select 
              v-model:value="formState.componentType" 
              placeholder=""
              allow-clear
            >
              <a-select-option 
                v-for="item in componentTypeOptions" 
                :key="item.value" 
                :value="item.value"
              >
                {{ item.label }}
              </a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
      </a-row>
      
      <!-- 第五行：组件存放路径（独占一行） -->
      <a-row>
        <a-col :span="24">
          <a-form-item 
            label="组件存放路径" 
            name="componentPath"
            :label-col="{ span: 4 }"
            :wrapper-col="{ span: 20 }"
          >
            <a-input 
              v-model:value="formState.componentPath" 
              placeholder="" 
            />
          </a-form-item>
        </a-col>
      </a-row>
      
      <!-- 第六行：风险级别 + 是否已评估处理 -->
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item 
            label="风险级别" 
            name="riskLevel"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <a-select 
              v-model:value="formState.riskLevel" 
              placeholder=""
              allow-clear
            >
              <a-select-option value="low">低</a-select-option>
              <a-select-option value="medium">中</a-select-option>
              <a-select-option value="high">高</a-select-option>
              <a-select-option value="critical">严重</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item 
            label="是否已评估处理" 
            name="isEvaluated"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <a-select 
              v-model:value="formState.isEvaluated" 
              placeholder=""
              allow-clear
            >
              <a-select-option :value="1">是</a-select-option>
              <a-select-option :value="0">否</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
      </a-row>
    </a-form>
  </a-modal>
</template>

<script setup>
import { ref, reactive, watch } from 'vue';
import { message } from 'ant-design-vue';

// Props
const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false
  },
  // 编辑模式时传入的数据
  editData: {
    type: Object,
    default: null
  }
});

// Emits
const emit = defineEmits(['update:modelValue', 'onSave', 'onCancel']);

// 表单ref
const formRef = ref(null);
const loading = ref(false);

// 控制弹框显示
const visible = ref(props.modelValue);

// 监听props变化
watch(() => props.modelValue, (newVal) => {
  visible.value = newVal;
  if (newVal && props.editData) {
    // 如果是编辑模式，填充表单数据
    Object.assign(formState, props.editData);
  } else if (newVal) {
    // 如果是新增模式，重置表单
    resetForm();
  }
});

watch(visible, (newVal) => {
  emit('update:modelValue', newVal);
});

// 表单数据
const formState = reactive({
  componentName: '',
  componentVersion: '',
  appAssetName: undefined,
  hostname: '',
  ip: '',
  componentSource: undefined,
  componentType: undefined,
  componentPath: '',
  riskLevel: undefined,
  isEvaluated: undefined
});

// 下拉选项数据（实际项目中可能从接口获取）
const appAssetOptions = ref([
  { value: 'app1', label: '应用资产1' },
  { value: 'app2', label: '应用资产2' },
  { value: 'app3', label: '应用资产3' }
]);

const componentSourceOptions = ref([
  { value: 'internal', label: '内部开发' },
  { value: 'external', label: '外部采购' },
  { value: 'opensource', label: '开源组件' }
]);

const componentTypeOptions = ref([
  { value: 'middleware', label: '中间件' },
  { value: 'database', label: '数据库' },
  { value: 'framework', label: '框架' },
  { value: 'library', label: '库' },
  { value: 'tool', label: '工具' }
]);

// 表单验证规则
const rules = {
  componentName: [
    { required: true, message: '请输入组件名称', trigger: 'blur' }
  ],
  componentVersion: [
    { required: false }
  ],
  appAssetName: [
    { required: true, message: '请选择应用资产名称', trigger: 'change' }
  ],
  hostname: [
    { required: true, message: '请输入主机名', trigger: 'blur' }
  ],
  ip: [
    { required: true, message: '请输入IP地址', trigger: 'blur' },
    { 
      pattern: /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/, 
      message: '请输入正确的IP地址格式', 
      trigger: 'blur' 
    }
  ],
  componentSource: [
    { required: true, message: '请选择组件来源', trigger: 'change' }
  ],
  componentType: [
    { required: true, message: '请选择组件类型', trigger: 'change' }
  ],
  componentPath: [
    { required: true, message: '请输入组件存放路径', trigger: 'blur' }
  ],
  riskLevel: [
    { required: true, message: '请选择风险级别', trigger: 'change' }
  ],
  isEvaluated: [
    { required: true, message: '请选择是否已评估处理', trigger: 'change' }
  ]
};

// 重置表单
const resetForm = () => {
  formState.componentName = '';
  formState.componentVersion = '';
  formState.appAssetName = undefined;
  formState.hostname = '';
  formState.ip = '';
  formState.componentSource = undefined;
  formState.componentType = undefined;
  formState.componentPath = '';
  formState.riskLevel = undefined;
  formState.isEvaluated = undefined;
  if (formRef.value) {
    formRef.value.clearValidate();
  }
};

// 确认提交
const handleOk = async () => {
  try {
    // 表单验证
    await formRef.value.validate();
    
    loading.value = true;
    
    // 模拟API调用延迟
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // 触发保存事件，将表单数据传递给父组件
    emit('onSave', { ...formState });
    
    message.success('保存成功！');
    visible.value = false;
    
    // 重置表单
    resetForm();
  } catch (error) {
    console.error('表单验证失败:', error);
    message.error('请填写必填项');
  } finally {
    loading.value = false;
  }
};

// 取消
const handleCancel = () => {
  emit('onCancel');
  visible.value = false;
  // 重置表单
  resetForm();
};

// 暴露给父组件的方法
defineExpose({
  resetForm,
  validate: () => formRef.value?.validate()
});
</script>

<style lang="less" scoped>
// 弹框样式调整
:deep(.ant-modal) {
  .ant-modal-header {
    padding: 16px 24px;
    border-bottom: 1px solid #f0f0f0;
    
    .ant-modal-title {
      font-size: 16px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.85);
    }
  }
  
  .ant-modal-close {
    top: 16px;
    right: 24px;
  }
  
  .ant-modal-body {
    padding: 24px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
  }
  
  .ant-modal-footer {
    padding: 10px 24px;
    border-top: 1px solid #f0f0f0;
    text-align: right;
    
    .ant-space {
      float: right;
    }
  }
}

// 表单样式调整
:deep(.ant-form) {
  .ant-row {
    margin-bottom: 0;
  }
  
  .ant-form-item {
    margin-bottom: 24px;
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  .ant-form-item-label {
    text-align: right;
    padding-right: 12px;
    
    > label {
      color: rgba(0, 0, 0, 0.85);
      font-size: 14px;
      height: 32px;
      line-height: 32px;
      
      // 必填项红色星号
      &.ant-form-item-required::before {
        display: inline-block;
        margin-right: 4px;
        color: #ff4d4f;
        font-size: 14px;
        font-family: SimSun, sans-serif;
        line-height: 1;
        content: '*';
      }
    }
  }
  
  // 输入框和选择框样式
  .ant-input,
  .ant-select {
    width: 100%;
  }
  
  .ant-select-selector {
    min-height: 32px;
  }
  
  // 去掉 placeholder 文字，保持空白
  .ant-input::placeholder,
  .ant-select-selection-placeholder {
    color: transparent;
  }
}

// 滚动条样式优化
:deep(.ant-modal-body)::-webkit-scrollbar {
  width: 6px;
}

:deep(.ant-modal-body)::-webkit-scrollbar-track {
  background: #f0f0f0;
  border-radius: 3px;
}

:deep(.ant-modal-body)::-webkit-scrollbar-thumb {
  background: #bfbfbf;
  border-radius: 3px;
  
  &:hover {
    background: #999;
  }
}
</style>